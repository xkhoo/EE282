# Analysis Proposal: Integrating Metagenome-Assembled Genome (MAG) Functional Annotations and Environmental Metadata for Downstream Machine Learning Analysis

## Introduction
Many microbial processes represented in Earth system models are often parameterized using simplified assumptions or values derived from laboratory isolates, which may not accurately reflect local community composition and functional trait potential. As meta-omics become more widely available, a practical approach is to translate genome-resolved trait annotations into a standardized dataset. This dataset should be both biologically interpretable and technically traceable from genomes to sampling sites. For this analysis proposal, I will build a reproducible workflow that integrates publicly available metagenome-assembled genomes (MAGs) across soil and rhizosphere environments, validates the mapping between MAG identifier and sample-level coordinates, computes dereplication-aware relative abundance, and annotates functional traits using bioinformatic tools. In addition to working with MAGs and trait annotation, I will extract environmental variables such as climate, soil, and vegetation from global raster products using geographical coordinates that correspond to those MAGs. The goal of my project for this course is to produce a clean trait x environment matrix for downstream machine learning (ML) analysis. Here, I will describe the datasets, the stepwise pipeline used to generate the ML-input tables, the specific exploratory data analyses, and the figures and tables that will be included in the final report.

## Datasets and Data Acquisition
### Primary datasets
#### MAG genome and MAG-level metadata
I will obtain publicly available MAGs from Joint Genome Institute Integrated Microbial Genomes & Microbiomes (JGI IMG/M) database (Chen et al. 2022). This will include downloading MAG FASTA files (.fna) along with their associated MAG-level metadata. The metadata will encompass genome quality metrics, taxonomic classifications, and sample identifiers that link the MAGs to their source metagenomes. To study environmental MAGs, I will specifically download MAGs from soil and the rhizosphere, and then combine these MAGs into a single master MAG dataset.

#### Sample (metagenome) metadata
To ensure correct geographic information for environmental extraction, I will compile metagenomic metadata from JGI IMG/M database. This metagenomic metadata includes geographical coordinates, sampling site descriptions, and ecosystem types related to those MAGs.

## Planned Analyses
### **1. Integrate MAG from different ecosystems and validate sample metadata** (completed)
The JGI IMG/M provides a bulk download link that allows me to obtain 10,385 rhizosphere MAGs and 54,659 soil MAGs, yielding a total of 65,044 environmental MAGs. I applied genome-quality filtering to retain medium-quality MAGs, defined as having a completeness ≥ 70% and a contamination ≤ 10%. Additionally, because accurate sampling locations are crucial for extracting environmental predictors, I removed MAGs linked to samples with missing geographic coordinates (latitude/longitude). After conducting quality control and excluding records that lacked coordinates, the final dataset included 30,522 MAGs derived from 3,745 metagenomes.

### **2. Extract environmental predictors from global raster product** (completed)
I obtained 19 bioclimatic variables from WorldClim v2.1 (Fick and Hijmans 2017), representing the average from 1970 to 2000, at a 1-km resolution. Evapotranspiration (ET) and Aridity Index (AI) variables were retrieved from Consortium for Spatial Information (CGIAR-CSI) (Zomer et al. 2022) , which model both ET and AI using interpolations provided by WorldClim. 10 soil variables were obtained from the SoilGrids 2.0 (Poggio et al. 2021), which has a 250m resolution.  Seven additional soil variables were obtained at a 1-km resolution from the land-atmosphere interaction research group at Sun Yat-sen University (Shangguan et al. 2014) while the elevation variable was obtained at a 30m resolution from Shuttle Radar Topography Mission (SRTM) (Farr et al. 2007). Both climatic and soil variables underwent reprojection to the EPSG:4326 coordinate system, rescaling, and resampling to a resolution of 1km using the terra package (Hijmans 2022) on RStudio v2024.12.1. The vegetation variables, derived from MODIS remote-sensing products, were subjected to the same reprojection, rescaling steps but utilized GDAL v3.11.0. Enhanced vegetation index (EVI) was available as monthly composites from 2001 to 2024. I aggregated monthly EVI rasters into annual mean EVI rasters, which were subsequently averaged to calculate a multi-year mean EVI. In contrast, net primary productivity (NPP) and land cover classification were provided as annual products, allowing us to directly compile annual rasters and calculated the multi-year means for each variable. These multi-year means provided time-invariant vegetation predictors that were comparable to other long-term environmental variables extracted. 

### **3. Dereplicate genomes and estimate relative abundance** 
To reduce redundancy among closely related genomes, I will dereplicate these medium-quality MAGs using dRep v2.0 (Olm et al. 2017), which assign each MAG to a secondary cluster at ~95% Average Nucleotide Identity (ANI) and identify a representative "winner" genome per cluster. These dereplication outputs will then be used to compute relative abundance (RA) within each metagenome using average coverage of MAG. I will calculate two RA definitions as a sensitivity check. For the representative-genome RA, I will retain only dRep “winner” genome per cluster and normalize its average coverage by the total coverage of all representative genomes in the same metagenome sample. For the cluster-level RA, I will first sum average coverage across all MAGs belonging to the same dereplication cluster within a metagenome sample, then normalize cluster totals by the sample-level sum across clusters. In both cases, I will confirm that RA sums to 1 per metagenome sample.

### **4. Annotate microbial traits from MAGs** (completed)
I annotated 192 functional traits from dereplicated MAGs using microTrait (Karaoz and Brodie 2022). Three trait types were generated by microTrait: 112 binary traits, 2 continuous traits, and 78 count-based traits (HMM hit counts). Binary traits were encoded as 0/1 per MAG, continuous traits were retained in their native units, and count traits were normalized by genome size to improve comparability across genomes. These MAG-level trait values were then aggregated to the sample level using community-weighted means (CWM) with dereplication-aware relative abundance weights described above. As one of the goals of my thesis project is studying traits relevant to carbon cycling, I also performed CAZyme annotations using dbCAN3 (Zheng et al. 2023) to better represent carbon decomposition potential. 

### **5. Trait data pre-processing and exploratory data analysis (EDA)**
I will preprocess MAG-level trait outputs to ensure consistent encoding across trait types and comparability across genomes. For traits that have strongly right-skewed distributions, I will apply log transformations after normalization. Using the RA computed above, I will then estimate community-weighted means (CWM) of a trait by aggregating MAG-level traits to the sample level, weighing each MAG's trait contribution by its RA within the sample. This results in two parallel ML-input tables: a representative-genome CWM table and a cluster-aggregated CWM table. For EDA, I will characterize trait prevalence and sparsity to distinguish widespread “core” traits from rare traits. I will also examine multivariate trait structure using trait–trait correlation heatmaps and principal component analysis (PCA) on the sample-level CWM matrix to identify interpretable covariance patterns that may reflect functional guilds or trait modules.

## Feasibility and Conclusion
Steps 1, 2, and 4 of the proposed analyses have been completed. I am currently finalizing step 3 (dRep-based cluster assignments and dereplication-aware RA estimations) and will then proceed to step 5 (trait preprocessing, CWM construction, and EDA). In conclusion, the proposed analyses focus on building a ML-input that links genome-resolved traits to broad-scale environmental gradients. The main outputs will be a MAG dataset that combines MAGs derived from soil and rhizosphere metagenome samples, two sample-level CWM trait matrices (representative-genome and cluster-level RA), and QC/EDA figures summarizing data loss, trait distributions, and trait covariance structure.    


## References

Chen I-MA, Chu K, Palaniappan K, Ratner A, Huang J, Huntemann M, Hajek P, Ritter Stephan J, Webb C, Wu D et al. 2022. The IMG/M data management and analysis system v.7: content updates and new features. Nucleic Acids Research 51: D723-D732.

Farr TG, Rosen PA, Caro E, Crippen R, Duren R, Hensley S, Kobrick M, Paller M, Rodriguez E, Roth L et al. 2007. The Shuttle Radar Topography Mission. Reviews of Geophysics 45.

Fick SE, Hijmans RJ. 2017. WorldClim 2: new 1-km spatial resolution climate surfaces for global land areas. International Journal of Climatology 37: 4302-4315.

Hijmans RJ. 2022. terra: Spatial Data Analysis. R package version 1.5-21.

Karaoz U, Brodie EL. 2022. microTrait: A Toolset for a Trait-Based Representation of Microbial Genomes. Frontiers in Bioinformatics Volume 2 - 2022.

Olm MR, Brown CT, Brooks B, Banfield JF. 2017. dRep: a tool for fast and accurate genomic comparisons that enables improved genome recovery from metagenomes through de-replication. The ISME Journal 11: 2864-2868.

Zheng J, Ge Q, Yan Y, Zhang X, Huang L, Yin Y. 2023. dbCAN3: automated carbohydrate-active enzyme and substrate annotation. Nucleic Acids Research 51: W115-W121. 
